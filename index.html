<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ç¨‹åˆ†æç³»çµ± - æ——è‰¦å…¨åŠŸèƒ½åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
    body { font-size: 20px; font-family: sans-serif; }
    input, select, textarea { font-size: 20px !important; }
    .table-header-darkblue { background-color: #1e3a8a !important; color: white !important; }
    .actual-detail-table td { font-size: 22px !important; }

    /* åˆ—å°å°ˆç”¨è¨­å®š */
    @media print {
        /* éš±è—ä¸å¿…è¦çš„å…ƒç´  */
        .no-print { display: none !important; }
        .no-print-flex { display: none !important; }

        /* ç¢ºä¿ Canvas é¡è‰²èˆ‡åœ–è¡¨æ­£å¸¸é¡¯ç¤º */
        canvas {
            display: block !important;
            max-width: 100% !important;
            /* å¼·åˆ¶ç€è¦½å™¨åˆ—å°é¡è‰²èˆ‡èƒŒæ™¯ */
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important;
        }

        /* å ±è¡¨å€å¡Šå„ªåŒ–ï¼šé˜²æ­¢å…§å®¹è¢«åˆ†é åˆ‡æ–·ï¼Œä¸¦åœ¨å€å¡Šå¾Œè‡ªå‹•åˆ†é  */
        .print-section {
            page-break-inside: avoid !important; /* é˜²æ­¢åœ–è¡¨æˆ–è¡¨æ ¼è¢«åˆ‡æˆå…©åŠ */
            break-inside: avoid !important;
            margin-bottom: 20px;
        }
    }
</style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div id="root"></div>
    <script type="text/babel">
const load = (k, f) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : f; } catch { return f; } };
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const sortMachines = (list) => [...new Set(list)].sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0));
const generateId = () => `id-${Date.now()}-${Math.floor(Math.random() * 1000000)}`;
// --- æ–°å¢ï¼šå–å¾— yymmdd æ ¼å¼çš„æ—¥æœŸ ---
const getShortDate = () => {
    const d = new Date();
    const yy = d.getFullYear().toString().slice(-2); // å– 2025 çš„æœ€å¾Œå…©ä½ 25
    const mm = (d.getMonth() + 1).toString().padStart(2, '0'); // æœˆä»½è£œé›¶
    const dd = d.getDate().toString().padStart(2, '0'); // æ—¥æœŸè£œé›¶
    return `${yy}${mm}${dd}`;
};
        
function App() {
    const [projects, setProjects] = React.useState(load("projects", []));
    const [currentProjectId, setCurrentProjectId] = React.useState(load("currentProjectId", ""));
    const [companies, setCompanies] = React.useState(load("companies", ["ç´˜å±•", "å…ƒé´»"]));
    const [currentCompany, setCurrentCompany] = React.useState(load("currentCompany", "ç´˜å±•"));
    const [records, setRecords] = React.useState(load("records", []));
    const [projectPlans, setProjectPlans] = React.useState(load("projectPlans", {}));
    const [machineOptions, setMachineOptions] = React.useState(load("machineOptions", ["25T åŠè»Š", "45T åŠè»Š", "é«˜ç©ºä½œæ¥­è»Š"]));
    const [projectStatus, setProjectStatus] = React.useState(load("projectStatus", {}));
    const [modalType, setModalType] = React.useState("");
    const [syncStatus, setSyncStatus] = React.useState({ loading: false, lastTime: load("lastSyncTime", "å°šæœªåŒæ­¥") });
    const [entryForm, setEntryForm] = React.useState({ date: new Date().toISOString().split('T')[0], labor: 0, support: 0, note: "", machines: [] });

    const GAS_URL = "https://script.google.com/macros/s/AKfycbzc7eXQObf5fkZ4iqje4_I4U3avG9fveDJe3UumMuaH5v0uSo8M75w_e_IbdRiuHtqPSg/exec";

    const currentProject = projects.find(p => p.id === currentProjectId);
    const currentPlans = projectPlans[currentProjectId] || [];
    const isCompleted = projectStatus[currentProjectId] || false;

    const projectRecords = records.filter(r => r.projectId === currentProjectId && r.company === currentCompany);
    const dailyDetails = {};
    projectRecords.forEach(r => {
        if (!dailyDetails[r.date]) dailyDetails[r.date] = { labor: 0, support: 0, machines: [], notes: [], raw: [] };
        dailyDetails[r.date].raw.push(r);
        if (r.type === "labor") { 
            dailyDetails[r.date].labor += Number(r.labor || 0); 
            dailyDetails[r.date].support += Number(r.support || 0); 
            if (r.note) dailyDetails[r.date].notes.push(r.note); 
        }
        else { dailyDetails[r.date].machines.push(`${r.spec}(${(Number(r.hr)/8).toFixed(1)}å°)`); }
    });

    const actTotalLabor = Object.values(dailyDetails).reduce((s, d) => s + d.labor, 0);
    const actTotalSupport = Object.values(dailyDetails).reduce((s, d) => s + d.support, 0);
    const actTotalSum = actTotalLabor + actTotalSupport;
    const estTotalLabor = currentPlans.reduce((s, p) => s + Number(p.labor || 0), 0);
    const estTotalSupport = currentPlans.reduce((s, p) => s + Number(p.support || 0), 0);
    const estTotalSum = estTotalLabor + estTotalSupport;

    const syncToCloud = async (customData = null) => {
        if (!currentProjectId && !customData) return;
        setSyncStatus(prev => ({ ...prev, loading: true }));
        const payload = {
            company: currentCompany,
            projectName: currentProject?.name,
            equipments: customData?.equipments || machineOptions, 
            plans: customData?.plans || currentPlans,
            records: customData?.records || records.filter(r => r.projectId === currentProjectId),
            projects: customData?.projects || projects,
            projectStatus: customData?.projectStatus || projectStatus
        };
        try {
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            const time = new Date().toLocaleTimeString();
            setSyncStatus({ loading: false, lastTime: time });
            save("lastSyncTime", time);
        } catch (e) { setSyncStatus(prev => ({ ...prev, loading: false })); }
    };

    const downloadFromCloud = async () => {
        setSyncStatus(prev => ({ ...prev, loading: true }));
        try {
            const response = await fetch(`${GAS_URL}?t=${Date.now()}`, { method: "GET" });
            const cloud = await response.json();
            const newProjects = cloud.projects ? cloud.projects.map(p => ({ id: String(p["å·¥ç¨‹ID"] || generateId()), name: String(p["å·¥ç¨‹åç¨±"]) })) : [];
            setProjects(newProjects);
            if (cloud.equipments) setMachineOptions(sortMachines(cloud.equipments.map(e => e["æ©Ÿå…·åç¨±"])));
            if (cloud.plans) {
                const planMap = {};
                cloud.plans.forEach((p, idx) => {
                    const matchedProj = newProjects.find(proj => proj.name === p["å·¥ç¨‹åç¨±"]);
                    const targetId = matchedProj ? matchedProj.id : p["å·¥ç¨‹åç¨±"];
                    if (!planMap[targetId]) planMap[targetId] = [];
                    let parsedMachines = [];
                    if (p["æ©Ÿå…·çµ„åˆ"] && typeof p["æ©Ÿå…·çµ„åˆ"] === 'string' && p["æ©Ÿå…·çµ„åˆ"].startsWith('[')) {
                        try { parsedMachines = JSON.parse(p["æ©Ÿå…·çµ„åˆ"]); } catch(e) { parsedMachines = []; }
                    }
                    planMap[targetId].push({ id: `pl-${Date.now()}-${idx}-${Math.random()}`, task: p["é è¨ˆå·¥ä½œå…§å®¹"] || "", labor: Number(p["å¤–åŒ…"] || 0), support: Number(p["ä½•é‘«"] || 0), machines: parsedMachines });
                });
                setProjectPlans(planMap);
            }
            if (cloud.records) {
                const actRecords = cloud.records.map((r, idx) => {
                    const matchedProj = newProjects.find(p => p.name === r["å·¥ç¨‹åç¨±"]);
                    let dateVal = r["æ—¥æœŸ"] || "";
                    if (dateVal && dateVal.includes("T")) dateVal = new Date(dateVal).toLocaleDateString('sv-SE');
                    return { id: `act-${Date.now()}-${idx}`, projectId: matchedProj ? matchedProj.id : r["å·¥ç¨‹åç¨±"], company: r["å…¬å¸"], date: dateVal, type: r["åˆ†é¡"], labor: Number(r["å¤–åŒ…"] || 0), support: Number(r["ä½•é‘«"] || 0), spec: r["è¦æ ¼"] || "", hr: Number(r["æ™‚æ•¸"] || 0), note: r["å‚™è¨»"] || "" };
                });
                setRecords(actRecords);
            }
            alert("ğŸ“¥ é›²ç«¯åŒæ­¥å®Œæˆï¼");
            setSyncStatus({ loading: false, lastTime: new Date().toLocaleTimeString() });
        } catch (e) { alert("è®€å–å¤±æ•—"); setSyncStatus(prev => ({ ...prev, loading: false })); }
    };

    // --- ä¿®æ”¹ Excel åŒ¯å‡ºæª”å ---
const exportToExcel = () => {
    if (!currentProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹");
    const fileName = `${getShortDate()}-${currentProject.name}-å®‰è£åˆ†æè¡¨.xlsx`;
    const wb = XLSX.utils.book_new();
    const pData = [["å¤©åº", "é è¨ˆå…§å®¹", "å¤–åŒ…", "ä½•é‘«", "æ©Ÿå…·çµ„åˆ"]];
    currentPlans.forEach((p, i) => pData.push([i+1, p.task, p.labor, p.support, (p.machines||[]).map(m=>`${m.spec}x${m.qty}`).join(',')]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pData), "é ä¼°è¦åŠƒ");
    const aData = [["æ—¥æœŸ", "å¤–åŒ…", "ä½•é‘«", "æ©Ÿå…·", "è¨˜äº‹"]];
    Object.entries(dailyDetails).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([date, d]) => aData.push([date, d.labor, d.support, d.machines.join(','), d.notes.join('/')]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aData), "å¯¦éš›åŸ·è¡Œ");
    XLSX.writeFile(wb, fileName);
};

// --- ä¿®æ”¹ Word åŒ¯å‡ºæª”å ---
const exportToWord = () => {
    if (!currentProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹");
    const fileName = `${getShortDate()}-${currentProject.name}-å®‰è£åˆ†æè¡¨.doc`;
    const content = document.getElementById('export-area').innerHTML;
    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border-collapse:collapse;width:100%;} th,td{border:1px solid black;padding:5px;text-align:center;}</style></head><body>${content}</body></html>`;
    const link = document.createElement('a');
    link.href = URL.createObjectURL(new Blob(['\ufeff', header], { type: 'application/msword' }));
    link.download = fileName;
    link.click();
};
    // --- ä¿®æ”¹ PDF / åˆ—å° è™•ç†é‚è¼¯ ---
const handlePrint = () => {
    if (!currentProject) {
        alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹æ¡ˆå†åŸ·è¡Œè¼¸å‡º");
        return;
    }
    
    // å„²å­˜åŸå§‹æ¨™é¡Œ
    const originalTitle = document.title;
    
    // é—œéµè¨­å®šï¼šå¼·åˆ¶ä¿®æ”¹ document.titleï¼Œç€è¦½å™¨æœƒå°‡æ­¤æ¨™é¡Œä½œç‚º PDF çš„é è¨­æª”å
    const fileName = `${getShortDate()}-${currentProject.name}-å®‰è£åˆ†æè¡¨`;
    document.title = fileName;
    
    // è§¸ç™¼ç€è¦½å™¨åˆ—å°è¦–çª—
    window.print();
    
    // å°å®Œå¾Œæ¢å¾©åŸæ¨™é¡Œï¼Œé¿å…å½±éŸ¿ç¶²é æ¨™ç±¤é¡¯ç¤º
    setTimeout(() => {
        document.title = originalTitle;
    }, 1000);
};

    const pieRef = React.useRef(null);
    const chartRef = React.useRef(null);
    React.useEffect(() => {
        if (!pieRef.current || actTotalSum === 0) return;
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(pieRef.current.getContext("2d"), {
            type: "pie",
            data: { labels: ["å¤–åŒ…", "ä½•é‘«"], datasets: [{ data: [actTotalLabor, actTotalSupport], backgroundColor: ["#1e3a8a", "#fbbf24"] }] },
            plugins: [ChartDataLabels],
            options: { plugins: { datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v) => (v*100/actTotalSum).toFixed(1) + "%" }}}
        });
    }, [actTotalSum, actTotalLabor, actTotalSupport]);

    React.useEffect(() => {
        save("projects", projects); save("records", records); save("projectPlans", projectPlans);
        save("machineOptions", machineOptions); save("currentProjectId", currentProjectId);
        save("projectStatus", projectStatus); save("currentCompany", currentCompany);
    }, [projects, records, projectPlans, machineOptions, currentProjectId, projectStatus, currentCompany]);

    return (
        <div className="max-w-7xl mx-auto pb-10">
            <div className="no-print bg-white p-6 rounded-xl shadow mb-6 border flex flex-wrap gap-4 items-center font-bold">
                <div className="flex items-center gap-2 mr-4 text-sm text-gray-500">
                    <span className={`w-3 h-3 rounded-full ${syncStatus.loading ? 'bg-yellow-400 animate-pulse' : 'bg-green-500'}`}></span>
                    <span>æœ€å¾ŒåŒæ­¥: {syncStatus.lastTime}</span>
                </div>
                <button className="bg-amber-500 text-white px-4 py-2 rounded shadow-md" onClick={downloadFromCloud}>ğŸ”„ åŒæ­¥é›²ç«¯(è®€å–)</button>
                <div className="h-8 border-r mx-2"></div>
                <select className="border-2 p-2 rounded text-blue-900 bg-blue-50" value={currentCompany} onChange={e=>setCurrentCompany(e.target.value)}>
                    {companies.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <select className="border-2 p-2 rounded text-blue-900" value={currentProjectId} onChange={e=>setCurrentProjectId(e.target.value)}>
    <option value="">é¸æ“‡å·¥ç¨‹æ¡ˆ</option>
    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
</select>

<button 
    className="bg-blue-600 text-white px-4 py-2 rounded font-bold" 
    onClick={()=>{
        const n=prompt("è«‹è¼¸å…¥æ–°å·¥ç¨‹åç¨±");
        if(n){
            const nid=generateId();
            const nl=[...projects,{id:nid,name:n}];
            setProjects(nl);
            syncToCloud({projects:nl}); // å³æ™‚åŒæ­¥æ–°æ¸…å–®
        }
    }}
>
    + æ–°å¢å·¥ç¨‹
</button>

<button 
    className="bg-red-500 text-white px-4 py-2 rounded font-bold" 
    onClick={()=>{
        if(!currentProjectId) return alert("è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å·¥ç¨‹");
        const targetName = currentProject?.name;
        if(confirm(`âš ï¸ è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ã€Œ${targetName}ã€åŠå…¶æ‰€æœ‰é æ¸¬èˆ‡å¯¦éš›ç´€éŒ„å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`)){
            const newList = projects.filter(p => p.id !== currentProjectId);
            setProjects(newList);
            setCurrentProjectId(""); // é‡è¨­é¸æ“‡å™¨
            
            // åŠæ™‚åŒæ­¥ï¼šé€šçŸ¥ GAS åˆªé™¤è©²å·¥ç¨‹åç¨±ä¸‹çš„æ‰€æœ‰è³‡æ–™åˆ—
            syncToCloud({
                projects: newList,
                projectName: targetName, // è®“ GAS çŸ¥é“è¦ deleteOldData çš„å°è±¡
                plans: [],               // å‚³é€ç©ºé™£åˆ—è§¸ç™¼åˆªé™¤å¾Œä¸å¯«å…¥
                records: []              // å‚³é€ç©ºé™£åˆ—è§¸ç™¼åˆªé™¤å¾Œä¸å¯«å…¥
            });
            alert("å·¥ç¨‹æ¡ˆå·²å¾é›²ç«¯èˆ‡æœ¬æ©Ÿåˆªé™¤");
        }
    }}
>
    ğŸ—‘ï¸ åˆªé™¤å·¥ç¨‹
</button>

<button className="bg-green-700 text-white px-4 py-2 rounded font-bold" onClick={exportToExcel}>ğŸ“Š Excel</button>
<button className="bg-blue-800 text-white px-4 py-2 rounded font-bold" onClick={exportToWord}>ğŸ“ Word</button>
<button className="bg-slate-700 text-white px-4 py-2 rounded font-bold" onClick={()=>setModalType("manageMachines")}>âš™ï¸ æ©Ÿå…·åº«</button>
{/* ä¿®æ”¹å¾Œçš„æŒ‰éˆ•çµ„ */}
<button className="bg-gray-700 text-white px-4 py-2 rounded font-bold" onClick={handlePrint}>ğŸ“„ è½‰ PDF</button>            
<button className="bg-gray-800 text-white px-6 py-2 rounded ml-auto font-bold" onClick={()=>window.print()}>ğŸ–¨ï¸ åˆ—å°</button>
            </div>

            <div id="export-area">
                {/* 1. é ä¼°è¦åŠƒ */}
                <div className="bg-white p-6 rounded-xl shadow mb-8 border-t-8 border-blue-900 print-section">
                    <h2 className="text-2xl font-black mb-4 underline">ğŸ“‹ é ä¼°è¦åŠƒ - {currentProject?.name} ({currentCompany})</h2>
                    <table className="w-full border-collapse">
                        <thead className="table-header-darkblue">
                            <tr><th className="border p-2">å¤©åº</th><th className="border p-2">å·¥ä½œå…§å®¹</th><th className="border p-2">å¤–åŒ…</th><th className="border p-2">ä½•é‘«</th><th className="border p-2">æ©Ÿå…·çµ„åˆ</th><th className="border p-2 no-print">æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            {currentPlans.map((p, i) => (
                                <tr key={p.id} className="text-center border-b hover:bg-gray-50">
                                    <td className="border p-2 font-bold">{i+1}</td>
                                    <td className="border p-2"><textarea className="w-full bg-transparent p-1" rows="1" value={p.task} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,task:e.target.value}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2"><input type="number" className="w-full text-center font-bold text-blue-800" value={p.labor} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,labor:Number(e.target.value)}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2"><input type="number" className="w-full text-center font-bold text-orange-600" value={p.support} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,support:Number(e.target.value)}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2">
                                        <div className="flex flex-col gap-1 items-center">
                                            {(p.machines || []).map((m, mi) => (
                                                <div key={`${p.id}-m-${mi}`} className="flex items-center gap-1 bg-blue-50 p-1 rounded no-print-flex">
                                                    <select className="border rounded font-bold text-sm bg-white" value={m.spec} onChange={e=>{const nm=p.machines.map((x,idx)=>idx===mi?{...x,spec:e.target.value}:x);const np=currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x);setProjectPlans({...projectPlans,[currentProjectId]:np});setTimeout(()=>syncToCloud({plans:np}),200);}}>
                                                        {machineOptions.map((opt, oi) => <option key={`${p.id}-${mi}-opt-${oi}`} value={opt}>{opt}</option>)}
                                                    </select>
                                                    <input type="number" className="w-12 border rounded text-center text-sm" value={m.qty} onChange={e=>{const nm=p.machines.map((x,idx)=>idx===mi?{...x,qty:Number(e.target.value)}:x);setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x)});}} onBlur={()=>syncToCloud()}/>
                                                    <button className="no-print text-red-500 font-bold px-1" onClick={()=>{const nm=p.machines.filter((_,idx)=>idx!==mi);const np=currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x);setProjectPlans({...projectPlans,[currentProjectId]:np});setTimeout(()=>syncToCloud({plans:np}),200);}}>âœ•</button>
                                                </div>
                                            ))}
                                            <div className="hidden print:block text-sm">{(p.machines || []).map((m, mi)=><div key={`p-${mi}`}>{m.spec}x{m.qty}</div>)}</div>
                                            <button className="text-xs text-blue-600 font-bold no-print underline" onClick={()=>{const nm=[...(p.machines||[]),{spec:machineOptions[0],qty:1}];const np=currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x);setProjectPlans({...projectPlans,[currentProjectId]:np});setTimeout(()=>syncToCloud({plans:np}),200);}}>+æ–°å¢æ©Ÿå…·</button>
                                        </div>
                                    </td>
                                    <td className="border p-2 no-print"><button className="text-red-500 font-bold hover:bg-red-50 px-2 rounded" onClick={()=>{if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")){const nl=currentPlans.filter(x=>x.id!==p.id);setProjectPlans({...projectPlans,[currentProjectId]:nl});setTimeout(()=>syncToCloud({plans:nl}),500);}}}>åˆªé™¤</button></td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot className="bg-blue-900 text-white font-black">
                            <tr><td colSpan="2" className="p-2 text-right">é è¨ˆåˆè¨ˆï¼š</td><td className="p-2">{estTotalLabor}</td><td className="p-2">{estTotalSupport}</td><td colSpan="2">å…± {estTotalSum} å·¥</td></tr>
                        </tfoot>
                    </table>
                    <button className="no-print mt-4 bg-blue-100 p-2 rounded font-bold shadow-sm" onClick={()=>{const nl=[...currentPlans,{id:generateId(),task:"",labor:0,support:0,machines:[]}];setProjectPlans({...projectPlans,[currentProjectId]:nl});setTimeout(()=>syncToCloud({plans:nl}),500);}}>+ æ–°å¢å¤©åº</button>
                </div>

                {/* 2. å¯¦éš›æ˜ç´° */}
                <div className="bg-white p-6 rounded-xl shadow mb-8 border-t-8 border-green-700 print-section">
                    <h2 className="text-2xl font-black text-green-800 mb-4 flex justify-between items-center">
                        <span>ğŸ“… å¯¦éš›æ˜ç´° - {currentProject?.name} ({currentCompany})</span>
                        <button className="no-print bg-green-600 text-white px-6 py-2 rounded font-bold shadow" onClick={()=>setModalType("entry")}>ğŸ“ ç™»æ‰“ç´€éŒ„</button>
                    </h2>
                    <table className="w-full border-collapse text-center actual-detail-table" style={{ tableLayout: 'fixed' }}>
                        <thead className="table-header-darkblue">
                            <tr>
                                <th style={{ width: '18%' }} className="border p-2">æ—¥æœŸ</th>
                                <th style={{ width: '8%' }} className="border p-2">å¤–åŒ…</th>
                                <th style={{ width: '8%' }} className="border p-2">ä½•é‘«</th>
                                <th style={{ width: '25%' }} className="border p-2">æ©Ÿå…·ç·¨è¼¯</th>
                                <th style={{ width: '31%' }} className="border p-2">è¨˜äº‹å‚™è¨»</th>
                                <th style={{ width: '10%' }} className="border p-2 no-print">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {Object.entries(dailyDetails).sort((a,b)=>a[0].localeCompare(b[0])).map(([date, data]) => (
                                <tr key={date} className="hover:bg-green-50 border-b">
                                    <td className="border p-2 font-bold text-xl text-center">{date}</td>
                                    <td className="border p-2 text-center">
                                        <input type="number" className="w-full text-center font-black text-blue-800 bg-transparent outline-none focus:border-b-2 focus:border-blue-500" value={data.labor} onChange={e=>{
                                            const nr = records.map(r => (r.projectId === currentProjectId && r.date === date && r.type === "labor") ? {...r, labor: Number(e.target.value)} : r);
                                            setRecords(nr);
                                        }} onBlur={()=>syncToCloud()}/>
                                    </td>
                                    <td className="border p-2 text-center">
                                        <input type="number" className="w-full text-center font-black text-orange-600 bg-transparent outline-none focus:border-b-2 focus:border-orange-500" value={data.support} onChange={e=>{
                                            const nr = records.map(r => (r.projectId === currentProjectId && r.date === date && r.type === "labor") ? {...r, support: Number(e.target.value)} : r);
                                            setRecords(nr);
                                        }} onBlur={()=>syncToCloud()}/>
                                    </td>
                                    <td className="border p-2 text-left">
                                        <div className="flex flex-col gap-1">
                                            {data.raw.filter(r => r.type === "crane").map((m, mi) => (
                                                <div key={m.id || mi} className="flex items-center gap-1 bg-blue-50 p-1 rounded no-print-flex">
                                                    <select className="border rounded font-bold bg-white text-xs flex-1" value={m.spec} onChange={e=>{
                                                        const nr = records.map(r => r.id === m.id ? {...r, spec: e.target.value} : r);
                                                        setRecords(nr); setTimeout(() => syncToCloud({records: nr.filter(x => x.projectId === currentProjectId)}), 200);
                                                    }}>{machineOptions.map((opt, oi)=><option key={oi} value={opt}>{opt}</option>)}</select>
                                                    <input type="number" className="w-10 border rounded text-center font-bold text-xs" value={m.hr} onChange={e=>{
                                                        const nr = records.map(r => r.id === m.id ? {...r, hr: Number(e.target.value)} : r);
                                                        setRecords(nr);
                                                    }} onBlur={()=>syncToCloud()}/>
                                                    <button className="text-red-500 font-bold px-1" onClick={()=>{const nr=records.filter(r=>r.id!==m.id);setRecords(nr);setTimeout(()=>syncToCloud({records:nr.filter(x=>x.projectId===currentProjectId)}), 200);}}>âœ•</button>
                                                </div>
                                            ))}
                                            <button className="text-xs text-blue-600 font-bold no-print underline" onClick={()=>{
                                                const nr = [...records, { id: generateId(), projectId: currentProjectId, company: currentCompany, date: date, type: "crane", spec: machineOptions[0], hr: 8 }];
                                                setRecords(nr); setTimeout(() => syncToCloud({records: nr.filter(x => x.projectId === currentProjectId)}), 200);
                                            }}>+å¢æ©Ÿå…·</button>
                                        </div>
                                    </td>
                                    <td className="border p-2">
                                        <textarea className="w-full bg-transparent p-1 text-base leading-tight outline-none focus:bg-white rounded" rows="2" value={data.notes.join('\n')} onChange={e=>{
                                            const nr = records.map(r => (r.projectId === currentProjectId && r.date === date && r.type === "labor") ? {...r, note: e.target.value} : r);
                                            setRecords(nr);
                                        }} onBlur={()=>syncToCloud()}/>
                                    </td>
                                    <td className="border p-2 no-print text-center">
                                        <button className="bg-red-100 text-red-600 px-3 py-1 rounded-md font-bold hover:bg-red-600 hover:text-white" onClick={()=>{if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ—¥å…¨éƒ¨ç´€éŒ„ï¼Ÿ")){const nr=records.filter(r=>!(r.projectId===currentProjectId && r.date===date));setRecords(nr);setTimeout(()=>syncToCloud({records:nr.filter(x=>x.projectId===currentProjectId)}),500);}}}>åˆªé™¤</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                        <tfoot className="bg-green-800 text-white font-black text-xl">
                            <tr>
                                <td className="p-2 border">å¯¦éš›åˆè¨ˆ</td>
                                <td className="p-2 border">{actTotalLabor}</td>
                                <td className="p-2 border">{actTotalSupport}</td>
                                <td colSpan="3" className="p-2 border text-right pr-10">å…± {actTotalSum} å·¥</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                {/* 3. æ–½å·¥åˆ†æå ±è¡¨ */}
                <div className="bg-white p-8 rounded-xl shadow border-4 border-gray-800 print-section">
    <h2 className="text-3xl font-black text-center mb-8 uppercase underline">
        {currentProject?.name} æ–½å·¥åˆ†æå ±è¡¨
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
        <div className="space-y-8">
                            <div>
                                <h3 className="font-bold text-2xl mb-4 border-l-8 border-blue-900 pl-4 text-blue-900">1. å·¥æ•¸åˆ†æçµ±è¨ˆ</h3>
                                <table className="w-full border-2 border-gray-800 text-center text-xl font-bold">
                                    <thead className="bg-gray-800 text-white">
                                        <tr><th className="p-2">é¡åˆ¥</th><th className="p-2">é è¨ˆ</th><th className="p-2">å¯¦éš›</th><th className="p-2">åå·®</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td className="border p-2">ç¸½å·¥æ•¸</td>
                                            <td className="border p-2">{estTotalSum}</td>
                                            <td className="border p-2">{actTotalSum}</td>
                                            <td className={`border p-2 ${actTotalSum > estTotalSum ? "text-red-600" : "text-green-700"}`}>
                                                {actTotalSum - estTotalSum}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div>
                                <h3 className="font-bold text-2xl mb-4 border-l-8 border-green-700 pl-4 text-green-800">2. æ©Ÿå…·å°æ¯”çµ±è¨ˆ (å°)</h3>
                                <table className="w-full border-2 border-gray-800 text-center text-lg font-bold">
                                    <thead className="bg-gray-100">
                                        <tr><th className="p-2 border">æ©Ÿå…·è¦æ ¼</th><th className="p-2 border">é è¨ˆ</th><th className="p-2 border">å¯¦éš›</th><th className="p-2 border">åå·®</th></tr>
                                    </thead>
                                    <tbody>
                                        {(() => {
                                            const estStats = {};
                                            currentPlans.forEach(p => (p.machines || []).forEach(m => { estStats[m.spec] = (estStats[m.spec] || 0) + Number(m.qty || 0); }));
                                            const actStats = {};
                                            projectRecords.filter(r => r.type === "crane").forEach(r => { actStats[r.spec] = (actStats[r.spec] || 0) + (Number(r.hr || 0) / 8); });
                                            const allSpecs = [...new Set([...Object.keys(estStats), ...Object.keys(actStats)])];
                                            if (allSpecs.length === 0) return <tr><td colSpan="4" className="p-4 text-center">å°šç„¡æ©Ÿå…·ç´€éŒ„</td></tr>;
                                            return allSpecs.map(spec => {
                                                const est = estStats[spec] || 0;
                                                const act = actStats[spec] || 0;
                                                const diff = act - est;
                                                return (
                                                    <tr key={spec}>
                                                        <td className="border p-2 text-left pl-4">{spec}</td>
                                                        <td className="border p-2">{est.toFixed(1)}</td>
                                                        <td className="border p-2">{act.toFixed(1)}</td>
                                                        <td className={`border p-2 ${diff > 0 ? "text-red-600" : diff < 0 ? "text-green-700" : ""}`}>
                                                            {diff > 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1)}
                                                        </td>
                                                    </tr>
                                                );
                                            });
                                        })()}
                                    </tbody>
                                </table>
                            </div>

                            <div className="p-6 bg-blue-50 border-4 border-blue-900 rounded-lg flex items-center justify-between shadow-inner">
                                <h4 className="text-2xl font-black">ç‹€æ…‹ï¼š{isCompleted ? <span className="text-red-600 font-black">å·²çµæ¡ˆ</span> : <span className="text-blue-600">æ–½å·¥ä¸­</span>}</h4>
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-bold no-print">æ¨™è¨˜çµæ¡ˆ:</span>
                                    <input type="checkbox" className="w-10 h-10 accent-blue-900 cursor-pointer no-print" checked={isCompleted} onChange={e=>{const ns={...projectStatus,[currentProjectId]:e.target.checked};setProjectStatus(ns);setTimeout(()=>syncToCloud({projectStatus:ns}),500);}}/>
                                </div>
                            </div>
                        </div>
                        
                       {/* åœ“é¤…åœ–å€å¡Š - ç§»é™¤ no-print ä¸¦åŠ ä¸Šåˆ—å°ç›¸å®¹æ€§ */}
        <div className="flex flex-col items-center justify-center" style={{ pageBreakInside: 'avoid' }}>
             <h3 className="font-bold text-2xl mb-4 text-center">å¯¦éš›å·¥æ•¸ä½”æ¯”åˆ†æ</h3>
             <div className="w-80 h-80 relative">
                <canvas ref={pieRef} style={{ width: '320px', height: '320px' }}></canvas>
             </div>
        </div>
    </div>
</div>
            </div>

            {modalType === "entry" && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-2xl shadow-2xl overflow-y-auto max-h-[90vh] border-t-8 border-green-600">
                        <h3 className="font-black text-3xl mb-6 text-green-700">ğŸ“ å¯¦éš›åŸ·è¡Œç™»éŒ„</h3>
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            <div><label className="font-bold">æ—¥æœŸ:</label><input type="date" className="border-2 p-3 w-full rounded" value={entryForm.date} onChange={e=>setEntryForm({...entryForm, date:e.target.value})}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="font-bold text-blue-800">å¤–åŒ…</label><input type="number" className="border-2 p-3 w-full rounded text-center font-bold" value={entryForm.labor} onChange={e=>setEntryForm({...entryForm, labor:e.target.value})}/></div>
                                <div><label className="font-bold text-orange-600">ä½•é‘«</label><input type="number" className="border-2 p-3 w-full rounded text-center font-bold" value={entryForm.support} onChange={e=>setEntryForm({...entryForm, support:e.target.value})}/></div>
                            </div>
                        </div>
                        <div className="mb-6 bg-gray-50 p-4 rounded-xl border">
                            <label className="font-black text-xl mb-3 block border-b">æ©Ÿå…·ä½¿ç”¨:</label>
                            {entryForm.machines.map((m, idx) => (
                                <div key={`entry-m-${idx}`} className="flex gap-2 mb-3 items-center">
                                    <select className="border-2 p-2 rounded flex-1 font-bold bg-white" value={m.spec} onChange={e=>{const nm=entryForm.machines.map((x,i)=>i===idx?{...x,spec:e.target.value}:x);setEntryForm({...entryForm,machines:nm})}}>
                                        {machineOptions.map((o, oi)=><option key={`eo-${oi}`} value={o}>{o}</option>)}
                                    </select>
                                    <input type="number" className="border-2 p-2 w-24 rounded text-center font-black" placeholder="æ™‚æ•¸" value={m.hr} onChange={e=>{const nm=entryForm.machines.map((x,i)=>i===idx?{...x,hr:e.target.value}:x);setEntryForm({...entryForm,machines:nm})}}/>
                                    <button className="text-red-500 font-bold text-xl px-2" onClick={()=>setEntryForm({...entryForm,machines:entryForm.machines.filter((_,i)=>i!==idx)})}>âœ•</button>
                                </div>
                            ))}
                            <button className="text-blue-600 font-bold mt-2 underline" onClick={()=>setEntryForm({...entryForm,machines:[...entryForm.machines,{spec:machineOptions[0],hr:8}]})}>+ æ–°å¢æ©Ÿå…·é …ç›®</button>
                        </div>
                        <textarea className="border-2 p-3 w-full rounded h-24 mb-6 shadow-inner" placeholder="å‚™è¨»è¨˜äº‹å…§å®¹..." value={entryForm.note} onChange={e=>setEntryForm({...entryForm,note:e.target.value})}/>
                        <div className="flex gap-4">
                            <button className="bg-green-700 text-white flex-1 py-5 rounded-xl font-black text-2xl shadow-lg hover:bg-green-800" onClick={() => {
                                const nid = generateId();
                                const nr = [...records, { projectId: currentProjectId, company: currentCompany, date: entryForm.date, id: nid, type: "labor", labor: Number(entryForm.labor), support: Number(entryForm.support), note: entryForm.note }];
                                entryForm.machines.forEach(m => { nr.push({ projectId: currentProjectId, company: currentCompany, date: entryForm.date, id: generateId(), type: "crane", spec: m.spec, hr: Number(m.hr) }); });
                                setRecords(nr); setModalType("");
                                setTimeout(() => syncToCloud({ records: nr.filter(r => r.projectId === currentProjectId) }), 500);
                            }}>å„²å­˜ä¸¦å³æ™‚åŒæ­¥</button>
                            <button className="bg-gray-200 px-8 rounded-xl font-bold" onClick={()=>setModalType("")}>å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            )}

            {modalType === "manageMachines" && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl font-bold">
                        <h3 className="font-black text-2xl mb-4 border-b pb-2">âš™ï¸ é›²ç«¯æ©Ÿå…·åº«ç®¡ç†</h3>
                        <div className="space-y-2 mb-4 max-h-64 overflow-y-auto">
                            {machineOptions.map((m, mi) => (
                                <div key={`manage-m-${mi}`} className="flex justify-between border p-2 rounded bg-gray-50 items-center">
                                    <span>{m}</span>
                                    <button className="text-red-500 hover:bg-red-100 px-2 rounded" onClick={()=>{const nl=machineOptions.filter(x=>x!==m);setMachineOptions(nl);syncToCloud({equipments:nl});}}>âœ•</button>
                                </div>
                            ))}
                        </div>
                        <button className="bg-blue-600 text-white w-full py-3 rounded font-bold shadow-md hover:bg-blue-700" onClick={()=>{const n=prompt("è¼¸å…¥æ–°æ©Ÿå…·è¦æ ¼åç¨±");if(n){const nl=sortMachines([...machineOptions,n]);setMachineOptions(nl);syncToCloud({equipments:nl});}}}>+ æ–°å¢è¦æ ¼é …ç›®</button>
                        <button className="w-full mt-4 text-gray-500 font-bold" onClick={()=>setModalType("")}>é—œé–‰è¦–çª—</button>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>
