<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é›²ç«¯å·¥æ•¸åŠè»Šåˆ†æç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        body { font-size: 20px; font-family: sans-serif; }
        input, select, textarea { font-size: 20px !important; }
        .table-header-darkblue { background-color: #1e3a8a !important; color: white !important; }
        .actual-detail-table td { font-size: 22px !important; }
        @media print { .no-print { display: none !important; } .print-section { break-after: page; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div id="root"></div>
    <script type="text/babel">

const load = (k, f) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : f; } catch { return f; } };
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const sortMachines = (list) => [...new Set(list)].sort((a,b) => (parseInt(a.match(/\d+/))||0) - (parseInt(b.match(/\d+/))||0));

function App() {
    const [projects, setProjects] = React.useState(load("projects", []));
    const [currentProjectId, setCurrentProjectId] = React.useState(load("currentProjectId", ""));
    const [companies, setCompanies] = React.useState(load("companies", ["ç´˜å±•", "å…ƒé´»"]));
    const [currentCompany, setCurrentCompany] = React.useState(load("currentCompany", "ç´˜å±•"));
    const [records, setRecords] = React.useState(load("records", []));
    const [projectPlans, setProjectPlans] = React.useState(load("projectPlans", {}));
    const [machineOptions, setMachineOptions] = React.useState(load("machineOptions", ["25T åŠè»Š", "45T åŠè»Š", "é«˜ç©ºä½œæ¥­è»Š"]));
    const [projectStatus, setProjectStatus] = React.useState(load("projectStatus", {}));
    const [modalType, setModalType] = React.useState("");
    const [syncStatus, setSyncStatus] = React.useState({ loading: false, lastTime: load("lastSyncTime", "å°šæœªåŒæ­¥") });
    const [entryForm, setEntryForm] = React.useState({ date: new Date().toISOString().split('T')[0], labor: 0, support: 0, note: "", machines: [] });

    const GAS_URL = "https://script.google.com/macros/s/AKfycbzc7eXQObf5fkZ4iqje4_I4U3avG9fveDJe3UumMuaH5v0uSo8M75w_e_IbdRiuHtqPSg/exec";
    
    const currentProject = projects.find(p => p.id === currentProjectId);
    const currentPlans = projectPlans[currentProjectId] || [];
    const isCompleted = projectStatus[currentProjectId] || false;

    // --- åŒæ­¥é‚è¼¯ ---
    const downloadFromCloud = async () => {
        setSyncStatus(prev => ({ ...prev, loading: true }));
        try {
            const response = await fetch(GAS_URL);
            const cloud = await response.json();
            if (cloud.projects) setProjects(cloud.projects.map(p => ({ id: String(p["å·¥ç¨‹ID"]), name: p["å·¥ç¨‹åç¨±"] })));
            if (cloud.equipments) setMachineOptions(sortMachines(cloud.equipments.map(e => e["æ©Ÿå…·åç¨±"])));
            if (cloud.plans) {
                const map = {};
                cloud.plans.forEach(p => {
                    const pId = projects.find(proj => proj.name === p["å·¥ç¨‹åç¨±"])?.id || p["å·¥ç¨‹åç¨±"];
                    if (!map[pId]) map[pId] = [];
                    map[pId].push({ id: Math.random(), task: p["é è¨ˆå·¥ä½œå…§å®¹"], labor: p["å¤–åŒ…"], support: p["ä½•é‘«"], machines: JSON.parse(p["æ©Ÿå…·çµ„åˆ"] || "[]") });
                });
                setProjectPlans(map);
            }
            const time = new Date().toLocaleTimeString();
            setSyncStatus({ loading: false, lastTime: time });
            save("lastSyncTime", time);
            alert("ğŸ“¥ é›²ç«¯è³‡æ–™åŒæ­¥æˆåŠŸï¼");
        } catch (e) { setSyncStatus(prev => ({ ...prev, loading: false })); }
    };

    const syncToCloud = async (customPayload = null) => {
        if (!currentProjectId && !customPayload) return;
        setSyncStatus(prev => ({ ...prev, loading: true }));
        const payload = customPayload || {
            company: currentCompany,
            projectName: currentProject?.name,
            equipments: machineOptions, 
            plans: currentPlans,
            records: records.filter(r => r.projectId === currentProjectId),
            projects: projects,
            projectStatus: projectStatus // åŒæ­¥çµæ¡ˆç‹€æ…‹
        };
        try {
            await fetch(GAS_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            setSyncStatus({ loading: false, lastTime: new Date().toLocaleTimeString() });
        } catch (e) { setSyncStatus(prev => ({ ...prev, loading: false })); }
    };

    // --- åŒ¯å‡ºåŠŸèƒ½ ---
    const exportToExcel = () => {
        if (!currentProject) return alert("è«‹å…ˆé¸æ“‡å·¥ç¨‹");
        const wb = XLSX.utils.book_new();
        const pData = [["å¤©åº", "é è¨ˆå…§å®¹", "å¤–åŒ…", "ä½•é‘«", "æ©Ÿå…·"]];
        currentPlans.forEach((p, i) => pData.push([i+1, p.task, p.labor, p.support, (p.machines||[]).map(m=>`${m.spec}x${m.qty}`).join(', ')]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(pData), "é ä¼°è¦åŠƒ");
        const aData = [["æ—¥æœŸ", "å¤–åŒ…", "ä½•é‘«", "æ©Ÿå…·", "å‚™è¨»"]];
        Object.entries(dailyDetails).forEach(([date, d]) => aData.push([date, d.labor, d.support, d.machines.join(','), d.notes.join('/')]));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aData), "å¯¦éš›åŸ·è¡Œ");
        XLSX.writeFile(wb, `${currentProject.name}-å ±è¡¨.xlsx`);
    };

    const exportToWord = () => {
        const clone = document.getElementById('export-area').cloneNode(true);
        clone.querySelectorAll('select').forEach(el => el.parentNode.replaceChild(document.createTextNode(el.options[el.selectedIndex]?.text || ""), el));
        clone.querySelectorAll('input, textarea').forEach(el => el.parentNode.replaceChild(document.createTextNode(el.value || ""), el));
        clone.querySelectorAll('.no-print').forEach(el => el.remove());
        const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><style>table{border-collapse:collapse;width:100%;} th,td{border:1px solid black;padding:5px;}</style></head><body>${clone.innerHTML}</body></html>`;
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob(['\ufeff', header], { type: 'application/msword' }));
        link.download = `${currentProject?.name}-å ±è¡¨.doc`;
        link.click();
    };

    // --- è¨ˆç®—é‚è¼¯ ---
    const projectRecords = records.filter(r => r.projectId === currentProjectId && r.company === currentCompany);
    const dailyDetails = {};
    projectRecords.forEach(r => {
        if (!dailyDetails[r.date]) dailyDetails[r.date] = { labor: 0, support: 0, machines: [], notes: [], raw: [] };
        dailyDetails[r.date].raw.push(r);
        if (r.type === "labor") { dailyDetails[r.date].labor += Number(r.labor); dailyDetails[r.date].support += Number(r.support); if (r.note) dailyDetails[r.date].notes.push(r.note); }
        else { dailyDetails[r.date].machines.push(`${r.spec}(${(Number(r.hr)/8).toFixed(1)}å°)`); }
    });
    const estTotalSum = currentPlans.reduce((s, p) => s + Number(p.labor) + Number(p.support), 0);
    const actTotalSum = Object.values(dailyDetails).reduce((s, d) => s + d.labor + d.support, 0);

    // --- ç›£è½èˆ‡æŒä¹…åŒ– ---
    React.useEffect(() => {
        save("projects", projects); save("records", records); save("projectPlans", projectPlans);
        save("machineOptions", machineOptions); save("currentProjectId", currentProjectId);
        save("projectStatus", projectStatus);
    }, [projects, records, projectPlans, machineOptions, currentProjectId, projectStatus]);

    const pieRef = React.useRef(null);
    const chartRef = React.useRef(null);
    React.useEffect(() => {
        if (!pieRef.current || (actTotalSum === 0)) return;
        if (chartRef.current) chartRef.current.destroy();
        const ctx = pieRef.current.getContext("2d");
        chartRef.current = new Chart(ctx, {
            type: "pie",
            data: { labels: ["å¤–åŒ…", "ä½•é‘«"], datasets: [{ data: [actTotalLabor, actTotalSupport], backgroundColor: ["#1e3a8a", "#fbbf24"] }] },
            plugins: [ChartDataLabels],
            options: { plugins: { datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v) => (v*100/actTotalSum).toFixed(1) + "%" }}}
        });
    }, [actTotalSum]);

    return (
        <div className="max-w-7xl mx-auto pb-10">
            {/* é ‚éƒ¨é¸å–® */}
            <div className="no-print bg-white p-6 rounded-xl shadow mb-6 border flex flex-wrap gap-4 items-center">
                <div className="flex items-center gap-2 mr-4 font-bold text-sm">
                    <span className={`w-3 h-3 rounded-full ${syncStatus.loading ? 'bg-yellow-400 animate-pulse' : 'bg-green-500'}`}></span>
                    <span>æœ€å¾ŒåŒæ­¥: {syncStatus.lastTime}</span>
                </div>
                <button className="bg-amber-500 text-white px-4 py-2 rounded font-bold shadow-md" onClick={downloadFromCloud}>ğŸ”„ åŒæ­¥æœ€æ–°(è®€å–é›²ç«¯)</button>
                <div className="h-8 border-r mx-2"></div>
                <select className="border-2 p-2 rounded font-bold text-blue-900" value={currentProjectId} onChange={e=>setCurrentProjectId(e.target.value)}>
                    <option value="">é¸æ“‡å·¥ç¨‹</option>
                    {projects.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
                <button className="bg-blue-600 text-white px-4 py-2 rounded font-bold" onClick={()=>{const n=prompt("å·¥ç¨‹åç¨±");if(n){const nl=[...projects,{id:Date.now().toString(),name:n}];setProjects(nl);setTimeout(()=>syncToCloud({projects:nl, equipments:machineOptions}),500)}}}>+ æ–°å¢å·¥ç¨‹</button>
                <button className="bg-green-700 text-white px-4 py-2 rounded font-bold" onClick={exportToExcel}>ğŸ“Š Excel</button>
                <button className="bg-blue-800 text-white px-4 py-2 rounded font-bold" onClick={exportToWord}>ğŸ“ Word</button>
                <button className="bg-slate-700 text-white px-4 py-2 rounded font-bold" onClick={()=>setModalType("manageMachines")}>âš™ï¸ æ©Ÿå…·åº«</button>
                <button className="bg-gray-800 text-white px-6 py-2 rounded font-bold ml-auto" onClick={()=>window.print()}>ğŸ–¨ï¸ åˆ—å°</button>
            </div>

            <div id="export-area">
                <div className="bg-white p-6 rounded-xl shadow mb-8 border-t-8 border-blue-900">
                    <h2 className="text-2xl font-black mb-4">ğŸ“‹ é ä¼°è¦åŠƒ - {currentProject?.name}</h2>
                    <table className="w-full border-collapse">
                        <thead className="table-header-darkblue">
                            <tr><th className="border p-2">å¤©åº</th><th className="border p-2">å…§å®¹</th><th className="border p-2">å¤–åŒ…</th><th className="border p-2">ä½•é‘«</th><th className="border p-2">æ©Ÿå…·çµ„åˆ</th><th className="border p-2 no-print">æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            {currentPlans.map((p, i) => (
                                <tr key={p.id} className="text-center">
                                    <td className="border p-2 font-bold">{i+1}</td>
                                    <td className="border p-2"><textarea className="w-full" rows="1" value={p.task} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,task:e.target.value}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2"><input type="number" className="w-full text-center" value={p.labor} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,labor:e.target.value}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2"><input type="number" className="w-full text-center" value={p.support} onChange={e=>setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,support:e.target.value}:x)})} onBlur={()=>syncToCloud()}/></td>
                                    <td className="border p-2">
                                        {(p.machines || []).map((m, mi) => <div key={mi} className="text-sm">{m.spec}x{m.qty} <button className="no-print text-red-500" onClick={()=>{const nm=p.machines.filter((_,idx)=>idx!==mi);setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x)});syncToCloud();}}>âœ•</button></div>)}
                                        <button className="text-xs text-blue-600 no-print" onClick={()=>{const nm=[...(p.machines||[]),{spec:machineOptions[0],qty:1}];setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.map(x=>x.id===p.id?{...x,machines:nm}:x)})}}>+æ©Ÿå…·</button>
                                    </td>
                                    <td className="border p-2 no-print"><button className="text-red-500 font-bold" onClick={()=>{setProjectPlans({...projectPlans,[currentProjectId]:currentPlans.filter(x=>x.id!==p.id)});syncToCloud();}}>åˆªé™¤</button></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    <button className="no-print mt-4 bg-blue-100 p-2 rounded font-bold" onClick={()=>setProjectPlans({...projectPlans,[currentProjectId]:[...currentPlans,{id:Date.now(),task:"",labor:0,support:0,machines:[]}]})}>+ æ–°å¢é ä¼°å¤©åº</button>
                </div>

                <div className="bg-white p-6 rounded-xl shadow mb-8 border-t-8 border-green-700">
                    <h2 className="text-2xl font-black text-green-800 mb-4 flex justify-between">
                        <span>ğŸ“… å¯¦éš›æ˜ç´° - {currentProject?.name}</span>
                        <button className="no-print bg-green-600 text-white px-6 py-2 rounded font-bold" onClick={()=>setModalType("entry")}>ğŸ“ ç™»æ‰“ç´€éŒ„</button>
                    </h2>
                    <table className="w-full border-collapse text-center">
                        <thead className="table-header-darkblue">
                            <tr><th className="border p-4">æ—¥æœŸ</th><th className="border p-4">å¤–åŒ…</th><th className="border p-4">ä½•é‘«</th><th className="border p-4">æ©Ÿå…·</th><th className="border p-4">è¨˜äº‹</th><th className="border p-4 no-print">æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            {Object.entries(dailyDetails).sort((a,b)=>a[0].localeCompare(b[0])).map(([date, data]) => (
                                <tr key={date} className="hover:bg-green-50">
                                    <td className="border p-4 font-bold">{date}</td>
                                    <td className="border p-4 font-black text-blue-800">{data.labor}</td>
                                    <td className="border p-4 font-black text-orange-600">{data.support}</td>
                                    <td className="border p-4 text-sm">{data.machines.join(', ')}</td>
                                    <td className="border p-4 italic text-gray-600">{data.notes.join('/')}</td>
                                    <td className="border p-4 no-print">
                                        <div className="flex gap-2 justify-center">
                                            <button className="text-blue-600 font-bold" onClick={()=>{
                                                const lab = data.raw.find(r=>r.type==="labor") || {labor:0,support:0,note:""};
                                                const mcs = data.raw.filter(r=>r.type==="crane").map(r=>({spec:r.spec,hr:r.hr}));
                                                setEntryForm({date, labor:lab.labor, support:lab.support, note:lab.note, machines:mcs});
                                                setRecords(records.filter(r=>!(r.projectId===currentProjectId && r.date===date)));
                                                setModalType("entry");
                                            }}>ç·¨è¼¯</button>
                                            <button className="text-red-500 font-bold" onClick={()=>{if(confirm("åˆªé™¤ï¼Ÿ")){setRecords(records.filter(r=>!(r.projectId===currentProjectId && r.date===date)));syncToCloud();}}}>åˆªé™¤</button>
                                        </div>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>

                {/* ğŸ“Š æç›Šåˆ†æå ±è¡¨å€ (çµæ¡ˆæ‰“å‹¾åœ¨é€™è£¡) */}
                <div className="bg-white p-8 rounded-xl shadow border-4 border-gray-800">
                    <h2 className="text-3xl font-black text-center mb-8 pb-4 border-b-4 border-gray-800 uppercase">{currentProject?.name} æ–½å·¥åˆ†æå ±è¡¨</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div>
                            <h3 className="font-bold text-2xl mb-4 border-l-8 border-blue-900 pl-4">å·¥æ•¸èˆ‡çµæ¡ˆç‹€æ…‹</h3>
                            <table className="w-full border-2 border-gray-800 text-center text-xl mb-6 font-bold">
                                <thead className="bg-gray-800 text-white"><tr><th>é è¨ˆ</th><th>å¯¦éš›</th><th>åå·®</th></tr></thead>
                                <tbody>
                                    <tr><td className="border p-2">{estTotalSum}</td><td className="border p-2">{actTotalSum}</td><td className={`border p-2 ${actTotalSum-estTotalSum > 0 ? "text-red-600" : "text-green-700"}`}>{actTotalSum-estTotalSum}</td></tr>
                                </tbody>
                            </table>
                            
                            {/* --- çµæ¡ˆæ‰“å‹¾æŒ‰éˆ• --- */}
                            <div className="mt-8 p-6 bg-blue-50 border-4 border-blue-900 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 className="text-2xl font-black">ğŸ“ˆ å·¥ç¨‹ç‹€æ…‹ï¼š{isCompleted ? <span className="text-red-600">å·²çµæ¡ˆ</span> : <span className="text-blue-600">æ–½å·¥ä¸­</span>}</h4>
                                    <p className="text-sm font-bold mt-1 text-gray-500 italic">å‹¾é¸å¾Œå°‡åŒæ­¥é›²ç«¯ç‹€æ…‹</p>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-bold">çµæ¡ˆæ‰“å‹¾:</span>
                                    <input 
                                        type="checkbox" 
                                        className="no-print w-10 h-10 cursor-pointer accent-blue-900" 
                                        checked={isCompleted} 
                                        onChange={e => {
                                            const newStatus = {...projectStatus, [currentProjectId]: e.target.checked};
                                            setProjectStatus(newStatus);
                                            // å‹¾é¸å®Œç«‹åˆ»è‡ªå‹•ä¸Šå‚³é›²ç«¯
                                            setTimeout(() => syncToCloud(), 500);
                                        }}
                                    />
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col items-center justify-center border-l border-gray-200">
                             <h3 className="font-bold text-2xl mb-4 text-center">æ©Ÿå…·å°æ¯”åˆ†æ</h3>
                             <div className="w-72 h-72 no-print"><canvas ref={pieRef}></canvas></div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Modal: ç™»æ‰“è¦–çª— */}
            {modalType === "entry" && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl w-full max-w-2xl border-t-8 border-green-600 shadow-2xl overflow-y-auto max-h-[95vh]">
                        <h3 className="font-black text-3xl mb-6 text-green-700">ğŸ“ å¯¦éš›ç´€éŒ„</h3>
                        <div className="grid grid-cols-2 gap-6 mb-6">
                            <div><label className="font-bold">æ—¥æœŸ:</label><input type="date" className="border-2 p-3 w-full" value={entryForm.date} onChange={e=>setEntryForm({...entryForm,date:e.target.value})}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="font-bold text-blue-800">å¤–åŒ…:</label><input type="number" className="border-2 p-3 w-full text-center" value={entryForm.labor} onChange={e=>setEntryForm({...entryForm,labor:e.target.value})}/></div>
                                <div><label className="font-bold text-orange-600">ä½•é‘«:</label><input type="number" className="border-2 p-3 w-full text-center" value={entryForm.support} onChange={e=>setEntryForm({...entryForm,support:e.target.value})}/></div>
                            </div>
                        </div>
                        <div className="mb-6 bg-gray-50 p-4 rounded-xl border">
                            <label className="font-black text-xl mb-3 block">æ©Ÿå…·:</label>
                            {entryForm.machines.map((m, idx) => (
                                <div key={idx} className="flex gap-2 mb-3">
                                    <select className="border-2 p-2 flex-1 font-bold" value={m.spec} onChange={e=>{const nm=entryForm.machines.map((x,i)=>i===idx?{...x,spec:e.target.value}:x);setEntryForm({...entryForm,machines:nm})}}>
                                        {machineOptions.map(o=><option key={o} value={o}>{o}</option>)}
                                    </select>
                                    <input type="number" className="border-2 p-2 w-20 text-center font-black" value={m.hr} onChange={e=>{const nm=entryForm.machines.map((x,i)=>i===idx?{...x,hr:e.target.value}:x);setEntryForm({...entryForm,machines:nm})}}/>
                                    <button onClick={()=>setEntryForm({...entryForm,machines:entryForm.machines.filter((_,i)=>i!==idx)})}>âœ•</button>
                                </div>
                            ))}
                            <button className="text-blue-600 font-bold" onClick={()=>setEntryForm({...entryForm,machines:[...entryForm.machines,{spec:machineOptions[0],hr:8}]})}>+ æ–°å¢æ©Ÿå…·</button>
                        </div>
                        <textarea className="border-2 p-3 w-full h-24 mb-6" placeholder="è¨˜äº‹..." value={entryForm.note} onChange={e=>setEntryForm({...entryForm,note:e.target.value})}/>
                        <div className="flex gap-4">
                            <button className="bg-green-700 text-white flex-1 py-5 rounded-2xl font-black text-2xl" onClick={() => {
                                const nr = [...records, { projectId: currentProjectId, company: currentCompany, date: entryForm.date, id: Date.now(), type: "labor", labor: Number(entryForm.labor), support: Number(entryForm.support), note: entryForm.note }];
                                entryForm.machines.forEach(m => { nr.push({ projectId: currentProjectId, company: currentCompany, date: entryForm.date, id: Date.now() + Math.random(), type: "crane", spec: m.spec, hr: Number(m.hr) }); });
                                setRecords(nr); setModalType("");
                                setTimeout(() => syncToCloud({ company: currentCompany, projectName: currentProject?.name, records: nr.filter(r => r.projectId === currentProjectId), plans: currentPlans, equipments: machineOptions, projects: projects }), 500);
                            }}>å„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
                            <button className="bg-gray-200 px-8 rounded-2xl font-bold" onClick={()=>setModalType("")}>å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            )}

            {/* Modal: æ©Ÿå…·åº« */}
            {modalType === "manageMachines" && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl font-bold">
                        <h3 className="font-black text-2xl mb-4 border-b">âš™ï¸ é›²ç«¯æ©Ÿå…·åº«</h3>
                        <div className="space-y-2 mb-4 max-h-60 overflow-y-auto">
                            {machineOptions.map(m => <div key={m} className="flex justify-between border p-2 rounded"><span>{m}</span><button className="text-red-500" onClick={()=>{const nl=machineOptions.filter(x=>x!==m);setMachineOptions(nl);syncToCloud({equipments:nl,projects:projects})}}>âœ•</button></div>)}
                        </div>
                        <button className="bg-blue-600 text-white w-full py-2 rounded font-bold" onClick={()=>{const n=prompt("åç¨±");if(n){const nl=sortMachines([...machineOptions,n]);setMachineOptions(nl);syncToCloud({equipments:nl,projects:projects})}}}>+ æ–°å¢</button>
                        <button className="w-full mt-4 text-gray-500" onClick={()=>setModalType("")}>é—œé–‰</button>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>
